

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5.3.4. A Multigroup Adjoint Response &mdash; OpenSn 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/collapsible-lists/css/tree_view.css?v=a885cde7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/nbsphinx-code-cells.css?v=2aa19091" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/pyopensn.css?v=59501074" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
      <script src="../../../../_static/collapsible-lists/js/CollapsibleLists.compressed.js?v=73120307"></script>
      <script src="../../../../_static/collapsible-lists/js/apply-collapsible-lists.js?v=660e4f45"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="5.3.5. Adjoint Method with Multiple Detector Responses" href="../glovebox_adjoint/glovebox_adj.html" />
    <link rel="prev" title="5.3.3. A Multigroup 2D Glovebox" href="../glovebox_forward/glovebox.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            OpenSn
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../install/index.html">Quick Install Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../theory/index.html">Theory Manual</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../mesh/index.html">1. Meshing and Partitioning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../xs/index.html">2. Cross Sections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../aquad/index.html">3. Angular Quadrature</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../logvol/index.html">4. Logical Volumes</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../index.html">5. Linear Boltzmann Solver</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../primer/index.html">5.1. Primer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../keigen/index.html">5.2. KEigen</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">5.3. Source Driven</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../mg_src_driven/hdpe_example.html">5.3.1. Slowing-Down in High-Density Polyethylene</a></li>
<li class="toctree-l4"><a class="reference internal" href="../detector_forward/detector.html">5.3.2. A Multigroup 1D Detector</a></li>
<li class="toctree-l4"><a class="reference internal" href="../glovebox_forward/glovebox.html">5.3.3. A Multigroup 2D Glovebox</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">5.3.4. A Multigroup Adjoint Response</a></li>
<li class="toctree-l4"><a class="reference internal" href="../glovebox_adjoint/glovebox_adj.html">5.3.5. Adjoint Method with Multiple Detector Responses</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../capi/rst/index.html">C++ API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pyapi/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../devguide/index.html">Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../appendices/index.html">Appendices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../gallery/index.html">Gallery</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">OpenSn</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Tutorials</a></li>
          <li class="breadcrumb-item"><a href="../../index.html"><span class="section-number">5. </span>Linear Boltzmann Solver</a></li>
          <li class="breadcrumb-item"><a href="../index.html"><span class="section-number">5.3. </span>Source Driven</a></li>
      <li class="breadcrumb-item active"><span class="section-number">5.3.4. </span>A Multigroup Adjoint Response</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="A-Multigroup-Adjoint-Response">
<h1><span class="section-number">5.3.4. </span>A Multigroup Adjoint Response<a class="headerlink" href="#A-Multigroup-Adjoint-Response" title="Link to this heading"></a></h1>
<p>In this example, we explore the use of an adjoint formulation of the linear Boltzmann equation to compute response functions in a specified region of interest (RoI). This problem builds on the corresponding example in <a class="reference external" href="../detector/detector_1d.ipynb">A Multigroup 1D Detector</a>. Additional information on the adjoint formalism can be found in the <a class="reference external" href="../../../theory/adjoint.rst">theory manual</a>.</p>
<p>The following is a complete transport simulation example. Each element of the simulation can be described in the sections below:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#Prerequisites"><span class="std std-ref">Prerequisites</span></a></p></li>
<li><p><a class="reference internal" href="#Geometry"><span class="std std-ref">Geometry</span></a></p></li>
<li><p><a class="reference internal" href="#Mesh"><span class="std std-ref">Mesh</span></a></p>
<ul>
<li><p><a class="reference internal" href="#Material-IDs"><span class="std std-ref">Material IDs</span></a></p></li>
<li><p><a class="reference internal" href="#Cross-Sections"><span class="std std-ref">Cross Sections</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#Solver"><span class="std std-ref">Solver</span></a></p>
<ul>
<li><p><a class="reference internal" href="#Angular-Quadrature"><span class="std std-ref">Angular Quadrature</span></a></p></li>
<li><p><a class="reference internal" href="#Group-Structure"><span class="std std-ref">Group Structure</span></a></p></li>
<li><p><a class="reference internal" href="#Adjoint-Source-Definition"><span class="std std-ref">Adjoint Source Definitionn</span></a></p></li>
<li><p><a class="reference internal" href="#Discrete-Ordinates-Problem"><span class="std std-ref">Discrete Ordinates Problem</span></a></p></li>
<li><p><a class="reference internal" href="#Execute"><span class="std std-ref">Execute</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#Post-Processing"><span class="std std-ref">Post Processing</span></a></p>
<ul>
<li><p><a class="reference internal" href="#Write-Flux-Moments"><span class="std std-ref">Write Flux Moments</span></a></p></li>
<li><p><a class="reference internal" href="#Detector-Response"><span class="std std-ref">Detector Response</span></a></p></li>
<li><p><a class="reference internal" href="#Linear-Field-Function"><span class="std std-ref">Linear Field Function</span></a></p></li>
<li><p><a class="reference internal" href="#Compute-Leakage"><span class="std std-ref">Compute Leakage</span></a></p></li>
<li><p><a class="reference internal" href="#Compute-Balance"><span class="std std-ref">Compute Balance</span></a></p></li>
</ul>
</li>
</ul>
<hr class="docutils" />
<section id="Prerequisites">
<h2><span class="section-number">5.3.4.1. </span><strong>Prerequisites</strong><a class="headerlink" href="#Prerequisites" title="Link to this heading"></a></h2>
<p>Before running this example, make sure that the <strong>Python module of OpenSn</strong> was installed.</p>
<section id="Converting-and-Running-this-Notebook-from-the-Terminal">
<h3><span class="section-number">5.3.4.1.1. </span>Converting and Running this Notebook from the Terminal<a class="headerlink" href="#Converting-and-Running-this-Notebook-from-the-Terminal" title="Link to this heading"></a></h3>
<p>To run this notebook from the terminal, simply type:</p>
<p><code class="docutils literal notranslate"><span class="pre">jupyter</span> <span class="pre">nbconvert</span> <span class="pre">--to</span> <span class="pre">python</span> <span class="pre">--execute</span> <span class="pre">detector_adj.ipynb</span></code>.</p>
<p>To run this notebook in parallel (for example, using 4 processes), simply type:</p>
<p><code class="docutils literal notranslate"><span class="pre">mpiexec</span> <span class="pre">-n</span> <span class="pre">4</span> <span class="pre">jupyter</span> <span class="pre">nbconvert</span> <span class="pre">--to</span> <span class="pre">python</span> <span class="pre">--execute</span> <span class="pre">detector_adj.ipynb</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">mpi4py</span><span class="w"> </span><span class="kn">import</span> <span class="n">MPI</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">size</span>
<span class="n">rank</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">rank</span>
<span class="n">barrier</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">barrier</span>

<span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running the LBS adjoint detector example with </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2"> MPI processors.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Running the LBS adjoint detector example with 1 MPI processors.
</pre></div></div>
</div>
</section>
<section id="Import-Requirements">
<h3><span class="section-number">5.3.4.1.2. </span>Import Requirements<a class="headerlink" href="#Import-Requirements" title="Link to this heading"></a></h3>
<p>Import required classes and functions from the Python interface of OpenSn. Make sure that the path to PyOpenSn is appended to Python’s PATH.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># assuming that the execute dir is the notebook dir</span>
<span class="c1"># this line is not necessary when PyOpenSn is installed using pip</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;../../..&quot;</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyopensn.mesh</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrthogonalMeshGenerator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyopensn.xs</span><span class="w"> </span><span class="kn">import</span> <span class="n">MultiGroupXS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyopensn.source</span><span class="w"> </span><span class="kn">import</span> <span class="n">PointSource</span><span class="p">,</span> <span class="n">VolumetricSource</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyopensn.aquad</span><span class="w"> </span><span class="kn">import</span> <span class="n">GLProductQuadrature1DSlab</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyopensn.solver</span><span class="w"> </span><span class="kn">import</span> <span class="n">DiscreteOrdinatesProblem</span><span class="p">,</span> <span class="n">SteadyStateSourceSolver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyopensn.response</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResponseEvaluator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyopensn.math</span><span class="w"> </span><span class="kn">import</span> <span class="n">Vector3</span><span class="p">,</span> <span class="n">VectorSpatialFunction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyopensn.fieldfunc</span><span class="w"> </span><span class="kn">import</span> <span class="n">FieldFunctionInterpolationVolume</span><span class="p">,</span> \
                               <span class="n">FieldFunctionInterpolationLine</span><span class="p">,</span> \
                               <span class="n">FieldFunctionGridBased</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyopensn.logvol</span><span class="w"> </span><span class="kn">import</span> <span class="n">RPPLogicalVolume</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyopensn.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">UseColor</span><span class="p">,</span> <span class="n">Finalize</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
OpenSn version 0.0.1
2025-09-20 01:45:09 Running OpenSn with 1 processes.

</pre></div></div>
</div>
<hr class="docutils" />
</section>
</section>
<section id="Geometry">
<h2><span class="section-number">5.3.4.2. </span><strong>Geometry</strong><a class="headerlink" href="#Geometry" title="Link to this heading"></a></h2>
<p>In this example, we define a 1D multi-group, source-driven detector response problem using the WIMS69 energy group structure. The neutron source is modeled as a 0.4 cm slab of Cf-252 encased in 0.1 cm slabs of stainless steel (SS-316). The detector is modeled as a 2.4 cm region of He-3 enclosed in a 0.07 cm SS-316 sleeve and surrounded by high-density polyethylene (HDPE). The geometric layout of the problem is shown below:</p>
<p><img alt="af2fc4f84bb84fe4bf942cb565017eea" src="../../../../_images/detector_geom.png" /></p>
<hr class="docutils" />
</section>
<section id="Mesh">
<h2><span class="section-number">5.3.4.3. </span><strong>Mesh</strong><a class="headerlink" href="#Mesh" title="Link to this heading"></a></h2>
<section id="Orthogonal-Mesh-Generation">
<h3><span class="section-number">5.3.4.3.1. </span>Orthogonal Mesh Generation<a class="headerlink" href="#Orthogonal-Mesh-Generation" title="Link to this heading"></a></h3>
<p>To generate the mesh for this problem, we use the in-house orthogonal mesh generator to create a simple Cartesian grid. We begin by creating a list of nodes along the spatial z-direction for each region.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Source Interfaces</span>
<span class="n">src</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.7</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">]</span>
<span class="n">d_src</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

<span class="c1"># Detector Interfaces</span>
<span class="n">det</span> <span class="o">=</span> <span class="p">[</span><span class="mf">13.0</span><span class="p">,</span> <span class="mf">16.73</span><span class="p">,</span> <span class="mf">16.8</span><span class="p">,</span> <span class="mf">19.2</span><span class="p">,</span> <span class="mf">19.27</span><span class="p">,</span> <span class="mf">23.0</span><span class="p">]</span>
<span class="n">d_det</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>

<span class="n">z</span>  <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">det</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">]</span>
<span class="n">dz</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="o">*</span><span class="n">d_src</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">*</span><span class="n">d_det</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>

<span class="n">ref</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">nodesz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">dz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">ref</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">i</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">dz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">ref</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">meshgen</span> <span class="o">=</span> <span class="n">OrthogonalMeshGenerator</span><span class="p">(</span><span class="n">node_sets</span><span class="o">=</span><span class="p">[</span><span class="n">nodesz</span><span class="p">])</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">meshgen</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0]  Done checking cell-center-to-face orientations
[0]  00:00:00.1 Establishing cell connectivity.
[0]  00:00:00.1 Vertex cell subscriptions complete.
[0]  00:00:00.1 Surpassing cell 46 of 460 (10%)
[0]  00:00:00.1 Surpassing cell 92 of 460 (20%)
[0]  00:00:00.1 Surpassing cell 139 of 460 (30%)
[0]  00:00:00.1 Surpassing cell 184 of 460 (40%)
[0]  00:00:00.1 Surpassing cell 230 of 460 (50%)
[0]  00:00:00.1 Surpassing cell 277 of 460 (60%)
[0]  00:00:00.1 Surpassing cell 323 of 460 (70%)
[0]  00:00:00.1 Surpassing cell 368 of 460 (80%)
[0]  00:00:00.1 Surpassing cell 414 of 460 (90%)
[0]  00:00:00.1 Surpassing cell 460 of 460 (100%)
[0]  00:00:00.1 Establishing cell boundary connectivity.
[0]  00:00:00.1 Done establishing cell connectivity.
[0]  Number of cells per partition (max,min,avg) = 460,460,460
[0]
[0]  Mesh statistics:
[0]    Global cell count             : 460
[0]    Local cell count (avg,max,min): 460,460,460
[0]    Ghost-to-local ratio (avg)    : 0
[0]
</pre></div></div>
</div>
</section>
<section id="Material-IDs">
<h3><span class="section-number">5.3.4.3.2. </span>Material IDs<a class="headerlink" href="#Material-IDs" title="Link to this heading"></a></h3>
<p>When using the in-house <code class="docutils literal notranslate"><span class="pre">OrthogonalMeshGenerator</span></code>, no material IDs are assigned. The user needs to assign material IDs to all cells. We will begin by assigning the background material ID with a value of 0.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid</span><span class="o">.</span><span class="n">SetUniformBlockID</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0]  00:00:00.1 Done setting block id 0 to all cells
</pre></div></div>
</div>
<p>Next we will assign material IDs for the detector and source. When assigning material IDs via logical volumes the IDs for each cell is overriden by the most recent assignment. That is to say, assigning a material ID of 1 to any region in our domain will override the previously set ID to those cells.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Detector Volume</span>
<span class="n">det_hdpe</span> <span class="o">=</span> <span class="n">RPPLogicalVolume</span><span class="p">(</span>
            <span class="n">infx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">infy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">zmin</span><span class="o">=</span><span class="n">det</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">zmax</span><span class="o">=</span><span class="n">det</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">grid</span><span class="o">.</span><span class="n">SetBlockIDFromLogicalVolume</span><span class="p">(</span><span class="n">det_hdpe</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">det_sleeve</span> <span class="o">=</span> <span class="n">RPPLogicalVolume</span><span class="p">(</span>
            <span class="n">infx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">infy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">zmin</span><span class="o">=</span><span class="n">det</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zmax</span><span class="o">=</span><span class="n">det</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">grid</span><span class="o">.</span><span class="n">SetBlockIDFromLogicalVolume</span><span class="p">(</span><span class="n">det_sleeve</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">det_he3</span> <span class="o">=</span> <span class="n">RPPLogicalVolume</span><span class="p">(</span>
            <span class="n">infx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">infy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">zmin</span><span class="o">=</span><span class="n">det</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">zmax</span><span class="o">=</span><span class="n">det</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">grid</span><span class="o">.</span><span class="n">SetBlockIDFromLogicalVolume</span><span class="p">(</span><span class="n">det_he3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Src Volume</span>
<span class="n">src_casing</span> <span class="o">=</span> <span class="n">RPPLogicalVolume</span><span class="p">(</span>
            <span class="n">infx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">infy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">zmin</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">zmax</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">grid</span><span class="o">.</span><span class="n">SetBlockIDFromLogicalVolume</span><span class="p">(</span><span class="n">src_casing</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">src_cf</span> <span class="o">=</span> <span class="n">RPPLogicalVolume</span><span class="p">(</span>
            <span class="n">infx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">infy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">zmin</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">zmax</span><span class="o">=</span><span class="n">src</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">grid</span><span class="o">.</span><span class="n">SetBlockIDFromLogicalVolume</span><span class="p">(</span><span class="n">src_cf</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="Cross-Sections">
<h3><span class="section-number">5.3.4.3.3. </span>Cross Sections<a class="headerlink" href="#Cross-Sections" title="Link to this heading"></a></h3>
<p>In this problem, we compute the multigroup absorption reaction rate in a He-3 detector. We begin by importing the multigroup cross sections, using the WIMS69 energy group structure for five materials:</p>
<ul class="simple">
<li><p>Air</p></li>
<li><p>HDPE</p></li>
<li><p>SS-316</p></li>
<li><p>He-3</p></li>
<li><p>Cf-252</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xs_dir</span> <span class="o">=</span> <span class="s2">&quot;WIMS69&quot;</span>
<span class="n">xs_air</span> <span class="o">=</span> <span class="n">MultiGroupXS</span><span class="p">()</span>
<span class="n">xs_air</span><span class="o">.</span><span class="n">LoadFromOpenSn</span><span class="p">(</span><span class="n">xs_dir</span><span class="o">+</span><span class="s2">&quot;/Air.cxs&quot;</span><span class="p">)</span>

<span class="n">xs_hdpe</span> <span class="o">=</span> <span class="n">MultiGroupXS</span><span class="p">()</span>
<span class="n">xs_hdpe</span><span class="o">.</span><span class="n">LoadFromOpenSn</span><span class="p">(</span><span class="n">xs_dir</span><span class="o">+</span><span class="s2">&quot;/HDPE.cxs&quot;</span><span class="p">)</span>

<span class="n">xs_steel</span> <span class="o">=</span> <span class="n">MultiGroupXS</span><span class="p">()</span>
<span class="n">xs_steel</span><span class="o">.</span><span class="n">LoadFromOpenSn</span><span class="p">(</span><span class="n">xs_dir</span><span class="o">+</span><span class="s2">&quot;/SS_316.cxs&quot;</span><span class="p">)</span>

<span class="n">xs_he3</span> <span class="o">=</span> <span class="n">MultiGroupXS</span><span class="p">()</span>
<span class="n">xs_he3</span><span class="o">.</span><span class="n">LoadFromOpenSn</span><span class="p">(</span><span class="n">xs_dir</span><span class="o">+</span><span class="s2">&quot;/He3.cxs&quot;</span><span class="p">)</span>

<span class="n">xs_cf</span> <span class="o">=</span> <span class="n">MultiGroupXS</span><span class="p">()</span>
<span class="n">xs_cf</span><span class="o">.</span><span class="n">LoadFromOpenSn</span><span class="p">(</span><span class="n">xs_dir</span><span class="o">+</span><span class="s2">&quot;/Cf252.cxs&quot;</span><span class="p">)</span>

<span class="n">xsecs</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;block_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;xs&quot;</span><span class="p">:</span> <span class="n">xs_air</span><span class="p">},</span>
         <span class="p">{</span><span class="s2">&quot;block_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;xs&quot;</span><span class="p">:</span> <span class="n">xs_hdpe</span><span class="p">},</span>
         <span class="p">{</span><span class="s2">&quot;block_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;xs&quot;</span><span class="p">:</span> <span class="n">xs_steel</span><span class="p">},</span>
         <span class="p">{</span><span class="s2">&quot;block_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;xs&quot;</span><span class="p">:</span> <span class="n">xs_he3</span><span class="p">},</span>
         <span class="p">{</span><span class="s2">&quot;block_ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="s2">&quot;xs&quot;</span><span class="p">:</span> <span class="n">xs_cf</span><span class="p">}]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0]  Reading OpenSn cross-section file &#34;WIMS69/Air.cxs&#34;
[0]  Reading OpenSn cross-section file &#34;WIMS69/HDPE.cxs&#34;
[0]  Reading OpenSn cross-section file &#34;WIMS69/SS_316.cxs&#34;
[0]  Reading OpenSn cross-section file &#34;WIMS69/He3.cxs&#34;
[0]  Reading OpenSn cross-section file &#34;WIMS69/Cf252.cxs&#34;
</pre></div></div>
</div>
<hr class="docutils" />
</section>
</section>
<section id="Solver">
<h2><span class="section-number">5.3.4.4. </span><strong>Solver</strong><a class="headerlink" href="#Solver" title="Link to this heading"></a></h2>
<section id="Angular-Quadrature">
<h3><span class="section-number">5.3.4.4.1. </span>Angular Quadrature<a class="headerlink" href="#Angular-Quadrature" title="Link to this heading"></a></h3>
<p>Since we are solving a 1D problem we will create Gauss-Legendre Product Quadrature for a 1D slab. In this case we will use 512 polar angles creating a 1D angular quadrature in <span class="math notranslate nohighlight">\(\mu\)</span> with a scattering order of 0.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pquad</span> <span class="o">=</span> <span class="n">GLProductQuadrature1DSlab</span><span class="p">(</span><span class="n">n_polar</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
                                  <span class="n">scattering_order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0]  Using 1D Slab Gauss–Legendre product quadrature with 512 angles and weight sum of 1.00
</pre></div></div>
</div>
</section>
<section id="Group-Structure">
<h3><span class="section-number">5.3.4.4.2. </span>Group Structure<a class="headerlink" href="#Group-Structure" title="Link to this heading"></a></h3>
<p>Since we are using the WIMS69 group structure, we define a groupset block with 69 energy groups.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_groups</span> <span class="o">=</span> <span class="mi">69</span>
<span class="n">grpsets</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;groups_from_to&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_groups</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="s2">&quot;angular_quadrature&quot;</span><span class="p">:</span> <span class="n">pquad</span><span class="p">,</span>
        <span class="s2">&quot;inner_linear_method&quot;</span><span class="p">:</span> <span class="s2">&quot;petsc_gmres&quot;</span><span class="p">,</span>
        <span class="s2">&quot;l_abs_tol&quot;</span><span class="p">:</span> <span class="mf">1.0e-9</span><span class="p">,</span>
        <span class="s2">&quot;l_max_its&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="s2">&quot;gmres_restart_interval&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="Adjoint-Source-Definition">
<h3><span class="section-number">5.3.4.4.3. </span>Adjoint Source Definition<a class="headerlink" href="#Adjoint-Source-Definition" title="Link to this heading"></a></h3>
<p>For solving the 1D transport problem via the adjoint operator we first define our adjoint source <span class="math notranslate nohighlight">\(q^{\dagger}\)</span> to be the detector volume and apply a source strength equivalent to the abosrption cross section of our detector <span class="math notranslate nohighlight">\(\sigma^{He3,g}_a\)</span>. (By default, adjoint sources are isotoropically distributed in angle across the souce domain)</p>
<p>To do this we create a <code class="docutils literal notranslate"><span class="pre">ResponseFunction</span></code>. A response function takes the place of defining the group strength. This can be used to specifiy responses to specific energy bins, or this case, capture our detector response.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">ResponseFunction</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">mat_id</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">xs_he3</span><span class="o">.</span><span class="n">sigma_a</span>
    <span class="k">return</span> <span class="n">response</span>
<span class="n">response_func</span> <span class="o">=</span> <span class="n">VectorSpatialFunction</span><span class="p">(</span><span class="n">ResponseFunction</span><span class="p">)</span>

<span class="n">adj_src</span> <span class="o">=</span> <span class="n">VolumetricSource</span><span class="p">(</span><span class="n">logical_volume</span><span class="o">=</span><span class="n">det_he3</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">response_func</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Discrete-Ordinates-Problem">
<h3><span class="section-number">5.3.4.4.4. </span>Discrete Ordinates Problem<a class="headerlink" href="#Discrete-Ordinates-Problem" title="Link to this heading"></a></h3>
<p>For establishing the discrete ordinate problem, we provide;</p>
<ul class="simple">
<li><p>mesh : The mesh</p></li>
<li><p>num_groups : The number of energy groups</p></li>
<li><p>groupsets : The groupsets block</p></li>
<li><p>scattering_order : The scattering order</p></li>
<li><p>xs_map : Cross section map</p></li>
<li><p>volumetric_sources : The volumetric source</p></li>
<li><p>boundary_conditions : The boundary conditions</p></li>
<li><p>options : Physics solver options</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">phys</span> <span class="o">=</span> <span class="n">DiscreteOrdinatesProblem</span><span class="p">(</span>
    <span class="n">mesh</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
    <span class="n">num_groups</span><span class="o">=</span><span class="n">num_groups</span><span class="p">,</span>
    <span class="n">groupsets</span><span class="o">=</span><span class="n">grpsets</span><span class="p">,</span>
    <span class="n">scattering_order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">xs_map</span><span class="o">=</span><span class="n">xsecs</span><span class="p">,</span>
    <span class="n">volumetric_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">adj_src</span><span class="p">],</span>
    <span class="n">boundary_conditions</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xmin&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;reflecting&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;xmax&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;reflecting&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ymin&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;reflecting&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ymax&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;reflecting&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;zmin&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;zmax&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;vacuum&quot;</span><span class="p">}</span>
    <span class="p">],</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;save_angular_flux&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
               <span class="s2">&quot;adjoint&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Execute">
<h3><span class="section-number">5.3.4.4.5. </span>Execute<a class="headerlink" href="#Execute" title="Link to this heading"></a></h3>
<p>We then create the physics solver, initialize it, and execute it.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ss_solver</span> <span class="o">=</span> <span class="n">SteadyStateSourceSolver</span><span class="p">(</span><span class="n">problem</span><span class="o">=</span><span class="n">phys</span><span class="p">)</span>
<span class="n">ss_solver</span><span class="o">.</span><span class="n">Initialize</span><span class="p">()</span>
<span class="n">ss_solver</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0]
[0]  Initializing LBS SteadyStateSourceSolver with name: LBSDiscreteOrdinatesProblem
[0]
[0]  Scattering order    : 0
[0]  Number of Groups    : 69
[0]  Number of Group sets: 1
[0]
[0]  ***** Groupset 0 *****
[0]  Groups:
[0]      0     1     2     3     4     5     6     7     8     9    10    11
[0]     12    13    14    15    16    17    18    19    20    21    22    23
[0]     24    25    26    27    28    29    30    31    32    33    34    35
[0]     36    37    38    39    40    41    42    43    44    45    46    47
[0]     48    49    50    51    52    53    54    55    56    57    58    59
[0]     60    61    62    63    64    65    66    67    68
[0]
[0]  Initializing spatial discretization.
[0]  Computing unit integrals.
[0]  Ghost cell unit cell-matrix ratio: 0%
[0]  Cell matrices computed.
[0]  *** WARNING ***  Computing the flux with fewer scattering moments than are present in the cross-section data for block 0
[0]  *** WARNING ***  Computing the flux with fewer scattering moments than are present in the cross-section data for block 1
[0]  *** WARNING ***  Computing the flux with fewer scattering moments than are present in the cross-section data for block 2
[0]  *** WARNING ***  Computing the flux with fewer scattering moments than are present in the cross-section data for block 3
[0]  *** WARNING ***  Computing the flux with fewer scattering moments than are present in the cross-section data for block 4
[0]  Initializing parallel arrays. G=69 M=1
[0]  Done with parallel arrays.
[0]  Volumetric source #0 has 40 total subscribing cells.
[0]  00:00:00.8 Initializing sweep datastructures.
[0]  00:00:00.8 Done initializing sweep datastructures.
[0]  00:00:00.8 Initialized angle aggregation.
[0]  Initializing WGS and AGS solvers
[0]  Total number of angular unknowns: 32501760
[0]  Number of lagged angular unknowns: 0(0%)
[0]
[0]
[0]  ********** Solving groupset 0 with PETSC_GMRES
[0]
[0]  Quadrature number of angles: 512
[0]  Groups 0 68
[0]
[0]  00:00:00.8 Computing b
[0]  00:00:01.6 WGS groups [0-68] Iteration     0 Residual         1
[0]  00:00:02.4 WGS groups [0-68] Iteration     1 Residual  0.169492
[0]  00:00:03.1 WGS groups [0-68] Iteration     2 Residual 0.0733121
[0]  00:00:03.9 WGS groups [0-68] Iteration     3 Residual  0.056536
[0]  00:00:04.7 WGS groups [0-68] Iteration     4 Residual 0.0460515
[0]  00:00:05.5 WGS groups [0-68] Iteration     5 Residual 0.0447157
[0]  00:00:06.2 WGS groups [0-68] Iteration     6 Residual 0.0420377
[0]  00:00:07.0 WGS groups [0-68] Iteration     7 Residual 0.0378549
[0]  00:00:07.8 WGS groups [0-68] Iteration     8 Residual 0.0346022
[0]  00:00:08.6 WGS groups [0-68] Iteration     9 Residual 0.0313861
[0]  00:00:09.3 WGS groups [0-68] Iteration    10 Residual 0.0294786
[0]  00:00:10.1 WGS groups [0-68] Iteration    11 Residual 0.0253271
[0]  00:00:10.9 WGS groups [0-68] Iteration    12 Residual 0.0172919
[0]  00:00:11.7 WGS groups [0-68] Iteration    13 Residual 0.0119881
[0]  00:00:12.4 WGS groups [0-68] Iteration    14 Residual 0.00959728
[0]  00:00:13.2 WGS groups [0-68] Iteration    15 Residual 0.00824602
[0]  00:00:13.9 WGS groups [0-68] Iteration    16 Residual 0.0071528
[0]  00:00:14.7 WGS groups [0-68] Iteration    17 Residual 0.00650336
[0]  00:00:15.5 WGS groups [0-68] Iteration    18 Residual 0.00576217
[0]  00:00:16.2 WGS groups [0-68] Iteration    19 Residual 0.00520831
[0]  00:00:17.0 WGS groups [0-68] Iteration    20 Residual 0.00462648
[0]  00:00:17.8 WGS groups [0-68] Iteration    21 Residual 0.00399869
[0]  00:00:18.6 WGS groups [0-68] Iteration    22 Residual 0.00342091
[0]  00:00:19.3 WGS groups [0-68] Iteration    23 Residual 0.00293254
[0]  00:00:20.1 WGS groups [0-68] Iteration    24 Residual 0.00240671
[0]  00:00:20.9 WGS groups [0-68] Iteration    25 Residual 0.00180988
[0]  00:00:21.6 WGS groups [0-68] Iteration    26 Residual 0.0013544
[0]  00:00:22.4 WGS groups [0-68] Iteration    27 Residual 0.000985589
[0]  00:00:23.2 WGS groups [0-68] Iteration    28 Residual 0.000618165
[0]  00:00:23.9 WGS groups [0-68] Iteration    29 Residual 0.000462905
[0]  00:00:24.7 WGS groups [0-68] Iteration    30 Residual 0.000406457
[0]  00:00:25.4 WGS groups [0-68] Iteration    31 Residual 0.000366398
[0]  00:00:26.2 WGS groups [0-68] Iteration    32 Residual 0.000338631
[0]  00:00:26.9 WGS groups [0-68] Iteration    33 Residual 0.000321261
[0]  00:00:27.7 WGS groups [0-68] Iteration    34 Residual 0.000299776
[0]  00:00:28.5 WGS groups [0-68] Iteration    35 Residual 0.00021187
[0]  00:00:29.3 WGS groups [0-68] Iteration    36 Residual 0.000113433
[0]  00:00:30.0 WGS groups [0-68] Iteration    37 Residual 7.70207e-05
[0]  00:00:30.8 WGS groups [0-68] Iteration    38 Residual 4.70869e-05
[0]  00:00:31.6 WGS groups [0-68] Iteration    39 Residual 2.70834e-05
[0]  00:00:32.4 WGS groups [0-68] Iteration    40 Residual 1.88603e-05
[0]  00:00:33.1 WGS groups [0-68] Iteration    41 Residual 1.31866e-05
[0]  00:00:33.9 WGS groups [0-68] Iteration    42 Residual 8.41508e-06
[0]  00:00:34.7 WGS groups [0-68] Iteration    43 Residual 5.50983e-06
[0]  00:00:35.4 WGS groups [0-68] Iteration    44 Residual 3.81981e-06
[0]  00:00:36.2 WGS groups [0-68] Iteration    45 Residual 2.90004e-06
[0]  00:00:36.9 WGS groups [0-68] Iteration    46 Residual 2.14286e-06
[0]  00:00:37.7 WGS groups [0-68] Iteration    47 Residual 1.72945e-06
[0]  00:00:38.5 WGS groups [0-68] Iteration    48 Residual 1.37934e-06
[0]  00:00:39.2 WGS groups [0-68] Iteration    49 Residual 1.03432e-06
[0]  00:00:40.0 WGS groups [0-68] Iteration    50 Residual 6.34689e-07
[0]  00:00:40.8 WGS groups [0-68] Iteration    51 Residual 4.06143e-07
[0]  00:00:41.6 WGS groups [0-68] Iteration    52 Residual 2.44733e-07
[0]  00:00:42.4 WGS groups [0-68] Iteration    53 Residual 9.78288e-08
[0]  00:00:43.1 WGS groups [0-68] Iteration    54 Residual 3.76214e-08
[0]  00:00:43.9 WGS groups [0-68] Iteration    55 Residual 2.27974e-08
[0]  00:00:44.6 WGS groups [0-68] Iteration    56 Residual 1.12505e-08
[0]  00:00:45.4 WGS groups [0-68] Iteration    57 Residual 6.36185e-09
[0]  00:00:46.2 WGS groups [0-68] Iteration    58 Residual 2.98874e-09
[0]  00:00:46.9 WGS groups [0-68] Iteration    59 Residual 1.4653e-09
[0]  00:00:47.7 WGS groups [0-68] Iteration    60 Residual 9.51392e-10 CONVERGED
[0]
[0]
[0]         Average sweep time (s):        0.722553
[0]         Sweep Time/Unknown (ns):       22.2312
[0]         Number of unknowns per sweep:  32501760
[0]
</pre></div></div>
</div>
</section>
</section>
<section id="Post-Processing">
<h2><span class="section-number">5.3.4.5. </span>Post Processing<a class="headerlink" href="#Post-Processing" title="Link to this heading"></a></h2>
<section id="Write-Flux-Moments">
<h3><span class="section-number">5.3.4.5.1. </span>Write Flux Moments<a class="headerlink" href="#Write-Flux-Moments" title="Link to this heading"></a></h3>
<p>When evaluating response functions via the adjoint formalism its efficiency derives from having access to the adjoint solution <span class="math notranslate nohighlight">\(\phi^{\dagger,g}\)</span>. For this, we export the adjoint flux moments to a .h5 file using <code class="docutils literal notranslate"><span class="pre">WriteFluxMoments</span></code>. The adjoint data is then saved to a location of our choosing.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;/Data&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">phys</span><span class="o">.</span><span class="n">WriteFluxMoments</span><span class="p">(</span><span class="n">data_dir</span><span class="o">+</span><span class="s2">&quot;/adjphi_p&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0]  Writing flux moments to /home/jason/Documents/Work/OpenSn/opensn-jay/doc/source/tutorials/lbs/src_driven/detector_adjoint/Data/adjphi_p
</pre></div></div>
</div>
</section>
<section id="Detector-Response">
<h3><span class="section-number">5.3.4.5.2. </span>Detector Response<a class="headerlink" href="#Detector-Response" title="Link to this heading"></a></h3>
<p>An adjoint formulation has no meaning without a corresponding forward response. For the volumetric source, we first define the forward source spectrum. In this case, we assign a uniform energy spectrum distributed throughout the source logical volume. Using <code class="docutils literal notranslate"><span class="pre">VolumetricSource</span></code>, this group-wise source is specified per unit length for material ID 4.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">([</span><span class="mf">1.00000E-11</span><span class="p">,</span> <span class="mf">5.00000E-09</span><span class="p">,</span> <span class="mf">1.00000E-08</span><span class="p">,</span> <span class="mf">1.50000E-08</span><span class="p">,</span> <span class="mf">2.00000E-08</span><span class="p">,</span>
                  <span class="mf">2.50000E-08</span><span class="p">,</span> <span class="mf">3.00000E-08</span><span class="p">,</span> <span class="mf">3.50000E-08</span><span class="p">,</span> <span class="mf">4.20000E-08</span><span class="p">,</span> <span class="mf">5.00000E-08</span><span class="p">,</span>
                  <span class="mf">5.80000E-08</span><span class="p">,</span> <span class="mf">6.70000E-08</span><span class="p">,</span> <span class="mf">8.00000E-08</span><span class="p">,</span> <span class="mf">1.00000E-07</span><span class="p">,</span> <span class="mf">1.40000E-07</span><span class="p">,</span>
                  <span class="mf">1.80000E-07</span><span class="p">,</span> <span class="mf">2.20000E-07</span><span class="p">,</span> <span class="mf">2.50000E-07</span><span class="p">,</span> <span class="mf">2.80000E-07</span><span class="p">,</span> <span class="mf">3.00000E-07</span><span class="p">,</span>
                  <span class="mf">3.20000E-07</span><span class="p">,</span> <span class="mf">3.50000E-07</span><span class="p">,</span> <span class="mf">4.00000E-07</span><span class="p">,</span> <span class="mf">5.00000E-07</span><span class="p">,</span> <span class="mf">6.25000E-07</span><span class="p">,</span>
                  <span class="mf">7.80000E-07</span><span class="p">,</span> <span class="mf">8.50000E-07</span><span class="p">,</span> <span class="mf">9.10000E-07</span><span class="p">,</span> <span class="mf">9.50000E-07</span><span class="p">,</span> <span class="mf">9.72000E-07</span><span class="p">,</span>
                  <span class="mf">9.96000E-07</span><span class="p">,</span> <span class="mf">1.02000E-06</span><span class="p">,</span> <span class="mf">1.04500E-06</span><span class="p">,</span> <span class="mf">1.07100E-06</span><span class="p">,</span> <span class="mf">1.09700E-06</span><span class="p">,</span>
                  <span class="mf">1.12300E-06</span><span class="p">,</span> <span class="mf">1.15000E-06</span><span class="p">,</span> <span class="mf">1.30000E-06</span><span class="p">,</span> <span class="mf">1.50000E-06</span><span class="p">,</span> <span class="mf">2.10000E-06</span><span class="p">,</span>
                  <span class="mf">2.60000E-06</span><span class="p">,</span> <span class="mf">3.30000E-06</span><span class="p">,</span> <span class="mf">4.00000E-06</span><span class="p">,</span> <span class="mf">9.87700E-06</span><span class="p">,</span> <span class="mf">1.59680E-05</span><span class="p">,</span>
                  <span class="mf">2.77000E-05</span><span class="p">,</span> <span class="mf">4.80520E-05</span><span class="p">,</span> <span class="mf">7.55014E-05</span><span class="p">,</span> <span class="mf">1.48729E-04</span><span class="p">,</span> <span class="mf">3.67263E-04</span><span class="p">,</span>
                  <span class="mf">9.06899E-04</span><span class="p">,</span> <span class="mf">1.42510E-03</span><span class="p">,</span> <span class="mf">2.23945E-03</span><span class="p">,</span> <span class="mf">3.51910E-03</span><span class="p">,</span> <span class="mf">5.53000E-03</span><span class="p">,</span>
                  <span class="mf">9.11800E-03</span><span class="p">,</span> <span class="mf">1.50300E-02</span><span class="p">,</span> <span class="mf">2.47800E-02</span><span class="p">,</span> <span class="mf">4.08500E-02</span><span class="p">,</span> <span class="mf">6.73400E-02</span><span class="p">,</span>
                  <span class="mf">1.11000E-01</span><span class="p">,</span> <span class="mf">1.83000E-01</span><span class="p">,</span> <span class="mf">3.02500E-01</span><span class="p">,</span> <span class="mf">5.00000E-01</span><span class="p">,</span> <span class="mf">8.21000E-01</span><span class="p">,</span>
                  <span class="mf">1.35300E+00</span><span class="p">,</span> <span class="mf">2.23100E+00</span><span class="p">,</span> <span class="mf">3.67900E+00</span><span class="p">,</span> <span class="mf">6.06550E+00</span><span class="p">,</span> <span class="mf">1.00000E+01</span><span class="p">])</span>
<span class="n">group_width</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
<span class="n">dE</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">groups</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">dL</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">Q</span> <span class="o">=</span> <span class="p">(</span><span class="n">group_width</span> <span class="o">/</span> <span class="n">dE</span> <span class="o">/</span> <span class="n">dL</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">fwd_src</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;material&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;block_id&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;strength&#39;</span><span class="p">:</span> <span class="n">Q</span><span class="p">}]}</span>
</pre></div>
</div>
</div>
<p>With the adjoint data in hand and a forward source defined, we now create a <code class="docutils literal notranslate"><span class="pre">ResponseEvaluator</span></code>.</p>
<p>We supply two options to the <code class="docutils literal notranslate"><span class="pre">evaluator</span></code>; the <code class="docutils literal notranslate"><span class="pre">buffers</span></code> (adjoint data) and the <code class="docutils literal notranslate"><span class="pre">sources</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">evaluator</span> <span class="o">=</span> <span class="n">ResponseEvaluator</span><span class="p">(</span><span class="n">problem</span> <span class="o">=</span> <span class="n">phys</span><span class="p">)</span>
<span class="n">evaluator</span><span class="o">.</span><span class="n">SetOptions</span><span class="p">(</span>
    <span class="n">buffers</span> <span class="o">=</span> <span class="p">[{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;detector&#39;</span><span class="p">,</span>
        <span class="s1">&#39;file_prefixes&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;flux_moments&#39;</span><span class="p">:</span> <span class="n">data_dir</span><span class="o">+</span><span class="s1">&#39;/adjphi_p&#39;</span><span class="p">}</span>
    <span class="p">}],</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">fwd_src</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0]  Reading flux moments from /home/jason/Documents/Work/OpenSn/opensn-jay/doc/source/tutorials/lbs/src_driven/detector_adjoint/Data/adjphi_p
</pre></div></div>
</div>
<p>For computing the detector response we make use of <code class="docutils literal notranslate"><span class="pre">EvaluateResponse</span></code> which given a buffer name will compute an inner product of the adjoint flux <span class="math notranslate nohighlight">\(\phi^{\dagger,}\)</span> against the forward source <span class="math notranslate nohighlight">\(q\)</span> using the <a class="reference external" href="../../../theory/adjoint.rst">duality principle</a> such that:</p>
<div class="math notranslate nohighlight">
\[\text{QoI} =  \sum^G_g \, \text{RR}^g = \sum^G_g \, \int_\mathcal{D} d^3r \, \int_{(4\pi)}   d\Omega  \, q^g(\vec{r},\vec\Omega) \psi^{\dagger,g}(\vec{r},\vec\Omega) = \sum^G_g \, \int_\mathcal{D}  d^3r  \, q^g(\vec{r}) \phi^{\dagger,g}(\vec{r})\]</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adj_resp</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">EvaluateResponse</span><span class="p">(</span><span class="s2">&quot;detector&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Adjoint Total Response :&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">adj_resp</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Adjoint Total Response : 1.237160e-01
</pre></div></div>
</div>
<p>With our field function defined, we can also export the multi-group adjoint flux moments, <span class="math notranslate nohighlight">\(\phi^{\dagger,g}\)</span>, to a .vtu file using <code class="docutils literal notranslate"><span class="pre">ExportMultipleToPVTU</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fflist</span> <span class="o">=</span> <span class="n">phys</span><span class="o">.</span><span class="n">GetScalarFieldFunctionList</span><span class="p">(</span><span class="n">only_scalar_flux</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_groups</span><span class="p">):</span>
    <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fflist</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

<span class="n">FFGrid</span> <span class="o">=</span> <span class="n">FieldFunctionGridBased</span>
<span class="n">FFGrid</span><span class="o">.</span><span class="n">ExportMultipleToPVTU</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="s2">&quot;AdjFlux/adjdetector_p&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0]  Exporting field functions to PVTU with file base &#34;AdjFlux/adjdetector_p&#34;
[0]  Done exporting field functions to PVTU.
</pre></div></div>
</div>
</section>
<section id="Linear-Field-Function">
<h3><span class="section-number">5.3.4.5.3. </span>Linear Field Function<a class="headerlink" href="#Linear-Field-Function" title="Link to this heading"></a></h3>
<p>To plot the scalar flux along a line segment of the problem we use <code class="docutils literal notranslate"><span class="pre">FieldFunctionInterpolationLine()</span></code></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="kn">import</span> <span class="n">walk</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_groups</span><span class="p">):</span>
    <span class="c1"># Linear Field Function</span>
    <span class="n">ffline</span> <span class="o">=</span> <span class="n">FieldFunctionInterpolationLine</span><span class="p">()</span>
    <span class="n">ffline</span><span class="o">.</span><span class="n">SetInitialPoint</span><span class="p">(</span><span class="n">Vector3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">ffline</span><span class="o">.</span><span class="n">SetFinalPoint</span><span class="p">(</span><span class="n">Vector3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">ffline</span><span class="o">.</span><span class="n">SetNumberOfPoints</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">ffline</span><span class="o">.</span><span class="n">AddFieldFunction</span><span class="p">(</span><span class="n">fflist</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ffline</span><span class="o">.</span><span class="n">Initialize</span><span class="p">()</span>
    <span class="n">ffline</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>
    <span class="n">ffline</span><span class="o">.</span><span class="n">ExportToCSV</span><span class="p">(</span><span class="s2">&quot;AdjFlux/adjdetector&quot;</span><span class="p">)</span>

<span class="c1"># Convert each CSV to a python dictionary</span>
<span class="k">def</span><span class="w"> </span><span class="nf">CSVToDict</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Collect each groupwise flux distribution into a dictionary</span>
<span class="c1"># Flux -&gt; g001 -&gt; {x,y,z,phi_g001_m00}</span>
<span class="c1">#      -&gt; g002 -&gt; {x,y,z,phi_g002_m00}</span>
<span class="c1">#      -&gt; .... -&gt;         ...</span>
<span class="c1">#      -&gt; g068 -&gt; {x,y,z,phi_g068_m00}</span>
<span class="n">Flux</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span> <span class="ow">in</span> <span class="n">walk</span><span class="p">(</span><span class="s1">&#39;AdjFlux/&#39;</span><span class="p">):</span>
   <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="n">grp</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="n">fwd_dict</span> <span class="o">=</span> <span class="n">CSVToDict</span><span class="p">(</span><span class="s2">&quot;AdjFlux/&quot;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">Flux</span><span class="p">[</span><span class="n">grp</span><span class="p">]</span> <span class="o">=</span> <span class="n">CSVToDict</span><span class="p">(</span><span class="s2">&quot;AdjFlux/&quot;</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span>

<span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Plot of the flux distribution</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">[</span><span class="s1">&#39;g003&#39;</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
    <span class="n">flux_g3</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">[</span><span class="s1">&#39;g003&#39;</span><span class="p">][</span><span class="s1">&#39;phi_g003_m00&#39;</span><span class="p">]</span>
    <span class="n">flux_g52</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">[</span><span class="s1">&#39;g052&#39;</span><span class="p">][</span><span class="s1">&#39;phi_g052_m00&#39;</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">flux_g3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Group 3: [1.353,2.231] MeV&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">flux_g52</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Group 52: [2.2E-07, 2.5E-07] MeV&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Distance (cm)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\phi^g(z)$&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0]  Exported CSV file for field func &#34;phi_g000_m00&#34; to &#34;AdjFlux/adjdetector_phi_g000_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g001_m00&#34; to &#34;AdjFlux/adjdetector_phi_g001_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g002_m00&#34; to &#34;AdjFlux/adjdetector_phi_g002_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g003_m00&#34; to &#34;AdjFlux/adjdetector_phi_g003_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g004_m00&#34; to &#34;AdjFlux/adjdetector_phi_g004_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g005_m00&#34; to &#34;AdjFlux/adjdetector_phi_g005_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g006_m00&#34; to &#34;AdjFlux/adjdetector_phi_g006_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g007_m00&#34; to &#34;AdjFlux/adjdetector_phi_g007_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g008_m00&#34; to &#34;AdjFlux/adjdetector_phi_g008_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g009_m00&#34; to &#34;AdjFlux/adjdetector_phi_g009_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g010_m00&#34; to &#34;AdjFlux/adjdetector_phi_g010_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g011_m00&#34; to &#34;AdjFlux/adjdetector_phi_g011_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g012_m00&#34; to &#34;AdjFlux/adjdetector_phi_g012_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g013_m00&#34; to &#34;AdjFlux/adjdetector_phi_g013_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g014_m00&#34; to &#34;AdjFlux/adjdetector_phi_g014_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g015_m00&#34; to &#34;AdjFlux/adjdetector_phi_g015_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g016_m00&#34; to &#34;AdjFlux/adjdetector_phi_g016_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g017_m00&#34; to &#34;AdjFlux/adjdetector_phi_g017_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g018_m00&#34; to &#34;AdjFlux/adjdetector_phi_g018_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g019_m00&#34; to &#34;AdjFlux/adjdetector_phi_g019_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g020_m00&#34; to &#34;AdjFlux/adjdetector_phi_g020_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g021_m00&#34; to &#34;AdjFlux/adjdetector_phi_g021_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g022_m00&#34; to &#34;AdjFlux/adjdetector_phi_g022_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g023_m00&#34; to &#34;AdjFlux/adjdetector_phi_g023_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g024_m00&#34; to &#34;AdjFlux/adjdetector_phi_g024_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g025_m00&#34; to &#34;AdjFlux/adjdetector_phi_g025_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g026_m00&#34; to &#34;AdjFlux/adjdetector_phi_g026_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g027_m00&#34; to &#34;AdjFlux/adjdetector_phi_g027_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g028_m00&#34; to &#34;AdjFlux/adjdetector_phi_g028_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g029_m00&#34; to &#34;AdjFlux/adjdetector_phi_g029_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g030_m00&#34; to &#34;AdjFlux/adjdetector_phi_g030_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g031_m00&#34; to &#34;AdjFlux/adjdetector_phi_g031_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g032_m00&#34; to &#34;AdjFlux/adjdetector_phi_g032_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g033_m00&#34; to &#34;AdjFlux/adjdetector_phi_g033_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g034_m00&#34; to &#34;AdjFlux/adjdetector_phi_g034_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g035_m00&#34; to &#34;AdjFlux/adjdetector_phi_g035_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g036_m00&#34; to &#34;AdjFlux/adjdetector_phi_g036_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g037_m00&#34; to &#34;AdjFlux/adjdetector_phi_g037_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g038_m00&#34; to &#34;AdjFlux/adjdetector_phi_g038_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g039_m00&#34; to &#34;AdjFlux/adjdetector_phi_g039_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g040_m00&#34; to &#34;AdjFlux/adjdetector_phi_g040_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g041_m00&#34; to &#34;AdjFlux/adjdetector_phi_g041_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g042_m00&#34; to &#34;AdjFlux/adjdetector_phi_g042_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g043_m00&#34; to &#34;AdjFlux/adjdetector_phi_g043_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g044_m00&#34; to &#34;AdjFlux/adjdetector_phi_g044_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g045_m00&#34; to &#34;AdjFlux/adjdetector_phi_g045_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g046_m00&#34; to &#34;AdjFlux/adjdetector_phi_g046_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g047_m00&#34; to &#34;AdjFlux/adjdetector_phi_g047_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g048_m00&#34; to &#34;AdjFlux/adjdetector_phi_g048_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g049_m00&#34; to &#34;AdjFlux/adjdetector_phi_g049_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g050_m00&#34; to &#34;AdjFlux/adjdetector_phi_g050_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g051_m00&#34; to &#34;AdjFlux/adjdetector_phi_g051_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g052_m00&#34; to &#34;AdjFlux/adjdetector_phi_g052_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g053_m00&#34; to &#34;AdjFlux/adjdetector_phi_g053_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g054_m00&#34; to &#34;AdjFlux/adjdetector_phi_g054_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g055_m00&#34; to &#34;AdjFlux/adjdetector_phi_g055_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g056_m00&#34; to &#34;AdjFlux/adjdetector_phi_g056_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g057_m00&#34; to &#34;AdjFlux/adjdetector_phi_g057_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g058_m00&#34; to &#34;AdjFlux/adjdetector_phi_g058_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g059_m00&#34; to &#34;AdjFlux/adjdetector_phi_g059_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g060_m00&#34; to &#34;AdjFlux/adjdetector_phi_g060_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g061_m00&#34; to &#34;AdjFlux/adjdetector_phi_g061_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g062_m00&#34; to &#34;AdjFlux/adjdetector_phi_g062_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g063_m00&#34; to &#34;AdjFlux/adjdetector_phi_g063_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g064_m00&#34; to &#34;AdjFlux/adjdetector_phi_g064_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g065_m00&#34; to &#34;AdjFlux/adjdetector_phi_g065_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g066_m00&#34; to &#34;AdjFlux/adjdetector_phi_g066_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g067_m00&#34; to &#34;AdjFlux/adjdetector_phi_g067_m00.csv&#34;
[0]  Exported CSV file for field func &#34;phi_g068_m00&#34; to &#34;AdjFlux/adjdetector_phi_g068_m00.csv&#34;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_lbs_src_driven_detector_adjoint_detector_adj_41_1.png" src="../../../../_images/tutorials_lbs_src_driven_detector_adjoint_detector_adj_41_1.png" />
</div>
</div>
</section>
<section id="Compute-Leakage">
<h3><span class="section-number">5.3.4.5.4. </span>Compute Leakage<a class="headerlink" href="#Compute-Leakage" title="Link to this heading"></a></h3>
<p>We can simultaneously compute the groupwise leakage rate at the left (<span class="math notranslate nohighlight">\(Z_\text{min}\)</span>) and/or right (<span class="math notranslate nohighlight">\(Z_\text{max}\)</span>) boundaries of the problem domain, <span class="math notranslate nohighlight">\(\vec{j}^g\big|_{\Gamma\pm}\)</span>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">emid</span> <span class="o">=</span> <span class="p">(</span><span class="n">groups</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span>

<span class="n">leakage</span> <span class="o">=</span> <span class="n">phys</span><span class="o">.</span><span class="n">ComputeLeakage</span><span class="p">([</span><span class="s2">&quot;zmin&quot;</span><span class="p">,</span> <span class="s2">&quot;zmax&quot;</span><span class="p">])</span>
<span class="n">lkg_zmin</span> <span class="o">=</span> <span class="n">leakage</span><span class="p">[</span><span class="s1">&#39;zmin&#39;</span><span class="p">]</span>
<span class="n">lkg_zmax</span> <span class="o">=</span> <span class="n">leakage</span><span class="p">[</span><span class="s1">&#39;zmax&#39;</span><span class="p">]</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Leakage spectrum</span>
    <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">))</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">emid</span><span class="p">,</span> <span class="n">lkg_zmin</span><span class="o">/</span><span class="n">group_width</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ZMin&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">emid</span><span class="p">,</span> <span class="n">lkg_zmax</span><span class="o">/</span><span class="n">group_width</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ZMax&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy (MeV)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\vec</span><span class="si">{j}</span><span class="s2">^</span><span class="si">{g}</span><span class="s2">(E)|_{\Gamma_{\text{+}}}$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Leakage Spectrum&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

    <span class="c1"># Leakage spectrum per unit lethargy</span>
    <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">))</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">emid</span><span class="p">,</span> <span class="n">lkg_zmin</span><span class="o">*</span><span class="n">emid</span><span class="o">/</span><span class="n">group_width</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ZMin&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">emid</span><span class="p">,</span> <span class="n">lkg_zmax</span><span class="o">*</span><span class="n">emid</span><span class="o">/</span><span class="n">group_width</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s1">&#39;steps&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;ZMax&quot;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy (MeV)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\vec</span><span class="si">{j}</span><span class="s2">^</span><span class="si">{g}</span><span class="s2">(u)|_{\Gamma_{\text{+}}}$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Leakage Spectrum per unit lethargy&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Total Leakage ZMin :&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lkg_zmin</span><span class="p">)</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Total Leakage ZMax :&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lkg_zmax</span><span class="p">)</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Total Leakage :&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lkg_zmin</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lkg_zmax</span><span class="p">)</span><span class="si">:</span><span class="s2">.6e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Total Leakage ZMin : 7.366151e-04
Total Leakage ZMax : 2.236497e-04
Total Leakage : 9.602648e-04
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_lbs_src_driven_detector_adjoint_detector_adj_43_1.png" src="../../../../_images/tutorials_lbs_src_driven_detector_adjoint_detector_adj_43_1.png" />
</div>
</div>
</section>
<section id="Compute-Balance">
<h3><span class="section-number">5.3.4.5.5. </span>Compute Balance<a class="headerlink" href="#Compute-Balance" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">balance</span> <span class="o">=</span> <span class="n">phys</span><span class="o">.</span><span class="n">ComputeBalance</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[0]  Balance table:
[0]   Absorption rate             = 2.992505e+01
[0]   Production rate             = 3.312229e+01
[0]   In-flow rate                = 0.000000e+00
[0]   Out-flow rate               = 4.720754e+00
[0]   Gain (In-flow + Production) = 3.312229e+01
[0]   Balance (Gain - Loss)       = -1.523505e+00
[0]   Balance/Gain, in %          = -4.599636e+00
</pre></div></div>
</div>
</section>
</section>
<section id="Finalize-(for-Jupyter-Notebook-only)">
<h2><span class="section-number">5.3.4.6. </span>Finalize (for Jupyter Notebook only)<a class="headerlink" href="#Finalize-(for-Jupyter-Notebook-only)" title="Link to this heading"></a></h2>
<p>In Python script mode, PyOpenSn automatically handles environment termination. However, this automatic finalization does not occur when running in a Jupyter notebook, so explicit finalization of the environment at the end of the notebook is required. Do not call the finalization in Python script mode, or in console mode.</p>
<p>Note that PyOpenSn’s finalization must be called before MPI’s finalization.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">IPython</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_ipython</span>

<span class="k">def</span><span class="w"> </span><span class="nf">finalize_env</span><span class="p">():</span>
    <span class="n">Finalize</span><span class="p">()</span>
    <span class="n">MPI</span><span class="o">.</span><span class="n">Finalize</span><span class="p">()</span>

<span class="n">ipython_instance</span> <span class="o">=</span> <span class="n">get_ipython</span><span class="p">()</span>
<span class="k">if</span> <span class="n">ipython_instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ipython_instance</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;post_execute&quot;</span><span class="p">,</span> <span class="n">finalize_env</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm -rf Data AdjFlux Results&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
0
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Elapsed execution time: 00:00:51.2
2025-09-20 01:46:00 OpenSn finished execution.
</pre></div></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../glovebox_forward/glovebox.html" class="btn btn-neutral float-left" title="5.3.3. A Multigroup 2D Glovebox" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../glovebox_adjoint/glovebox_adj.html" class="btn btn-neutral float-right" title="5.3.5. Adjoint Method with Multiple Detector Responses" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023-present, OpenSn team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>