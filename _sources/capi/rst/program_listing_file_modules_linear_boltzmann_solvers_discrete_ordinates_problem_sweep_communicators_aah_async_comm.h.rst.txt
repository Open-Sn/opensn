
.. _program_listing_file_modules_linear_boltzmann_solvers_discrete_ordinates_problem_sweep_communicators_aah_async_comm.h:

Program Listing for File aah_async_comm.h
=========================================

|exhale_lsh| :ref:`Return to documentation for file <file_modules_linear_boltzmann_solvers_discrete_ordinates_problem_sweep_communicators_aah_async_comm.h>` (``modules/linear_boltzmann_solvers/discrete_ordinates_problem/sweep/communicators/aah_async_comm.h``)

.. |exhale_lsh| unicode:: U+021B0 .. UPWARDS ARROW WITH TIP LEFTWARDS

.. code-block:: cpp

   // SPDX-FileCopyrightText: 2024 The OpenSn Authors <https://open-sn.github.io/opensn/>
   // SPDX-License-Identifier: MIT
   
   #pragma once
   
   #include "modules/linear_boltzmann_solvers/discrete_ordinates_problem/sweep/communicators/async_comm.h"
   #include "modules/linear_boltzmann_solvers/discrete_ordinates_problem/sweep/communicators/aah_message_struct.h"
   #include "modules/linear_boltzmann_solvers/discrete_ordinates_problem/sweep/sweep.h"
   #include "mpicpp-lite/mpicpp-lite.h"
   #include <vector>
   
   namespace mpi = mpicpp_lite;
   
   namespace opensn
   {
   
   /**
    * Handles interprocess communication related to sweeping.
    */
   class AAH_ASynchronousCommunicator : public AsynchronousCommunicator
   {
   public:
     AAH_ASynchronousCommunicator(FLUDS& fluds,
                                  unsigned int num_groups,
                                  std::size_t num_angles,
                                  int max_mpi_message_size,
                                  const MPICommunicatorSet& comm_set);
   
     int GetMaxNumMessages() const { return max_num_messages_; }
   
     void SetMaxNumMessages(int count) { max_num_messages_ = count; }
   
     bool DoneSending() const;
   
     /**
      * Initializes delayed upstream data. This method gets called
      * when a sweep scheduler is constructed.
      */
     void InitializeDelayedUpstreamData();
   
     /**
      * This is the final level of initialization before a sweep-chunk executes.
      * Once all upstream dependencies are met and if the sweep scheduler places
      * this angleset as "ready-to-execute", then the angle-set will call this
      * method. It is also fairly important in terms of memory to only allocate
      * these chunks of memory when actually ready to use them since they form the
      * majority of memory usage.
      */
     void InitializeLocalAndDownstreamBuffers();
   
     /// Sends downstream psi. This method gets called after a sweep chunk has executed
     void SendDownstreamPsi(int angle_set_num);
   
     /// Receives delayed data from successor locations.
     bool ReceiveDelayedData(int angle_set_num);
   
     /// Sends downstream psi.
     void ClearDownstreamBuffers();
   
     /// Check if all upstream dependencies have been met and receives it as it becomes available.
     AngleSetStatus ReceiveUpstreamPsi(int angle_set_num);
   
     /**
      * Receive all upstream Psi. This method is called from within  an advancement of an angleset,
      * right after execution.
      */
     void ClearLocalAndReceiveBuffers();
   
     /// Clear flags in preperation for another sweep.
     void Reset();
   
   protected:
     /**
      * Builds message structure.
      *
      * Outgoing and incoming data needs to be sub-divided into messages
      * each of which is smaller than the maximum message size. There are
      * three parts to this: predecessors, delayed-predecessors and successors.
      *
      * This method gets called by an angleset that subscribes to this
      * sweepbuffer.
      */
     void BuildMessageStructure();
   
   private:
     unsigned int num_groups_;
     std::size_t num_angles_;
     int max_num_messages_;
     int max_mpi_message_size_;
     bool done_sending_;
     bool data_initialized_;
     bool upstream_data_initialized_;
   
     std::vector<std::vector<bool>> preloc_msg_received_;
     std::vector<std::vector<AAH_MessageDetails>> preloc_msg_data_;
   
     std::vector<std::vector<bool>> delayed_preloc_msg_received_;
     std::vector<std::vector<AAH_MessageDetails>> delayed_preloc_msg_data_;
   
     std::vector<mpi::Request> deploc_msg_request_;
     std::vector<std::vector<AAH_MessageDetails>> deploc_msg_data_;
   };
   
   } // namespace opensn
